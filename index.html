
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuadrante de Turnos</title>
    <style>
        :root {
            --font-family: Arial, Helvetica, sans-serif;
            --color-fondo: #e9e9e9;
            --color-superficie: #ffffff;
            --color-texto-principal: #000000;
            --color-borde-tabla: #333333;

            /* Colores Fieles a la Imagen */
            --color-header-dia: #ffff00; /* Amarillo */
            --color-header-nombre: #92d050; /* Verde */
            --color-finde: #ffff00; /* Amarillo para fines de semana */
            --color-defecto: #ffffff; /* Blanco para días de semana */
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: var(--font-family);
            background-color: var(--color-fondo);
            color: var(--color-texto-principal);
            margin: 0;
            padding: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: auto;
            display: grid;
            gap: 1.5rem;
        }
        
        h1, h2, h3 { text-align: center; color: var(--color-texto-principal); margin: 0 0 1rem 0; font-weight: bold; }
        h1 { font-size: 2rem; } h2 { font-size: 1.5rem; } h3 { font-size: 1.25rem; }

        .seccion {
            background-color: var(--color-superficie);
            padding: 1.5rem;
            border: 1px solid #ccc;
        }

        .control-grupo { display: flex; flex-direction: column; }
        .control-grupo label { margin-bottom: 0.5rem; font-weight: bold; }
        .control-grupo select, .control-grupo input {
            padding: 0.5rem;
            border: 1px solid #999;
            width: 100%;
            font-family: inherit;
            font-size: 1rem;
        }

        .boton {
            padding: 0.75rem 1.5rem; color: white; border: 1px solid black;
            cursor: pointer; font-weight: bold;
            text-align: center; font-size: 1rem;
            transition: opacity 0.2s;
        }
        .boton:hover { opacity: 0.85; }
        .boton-principal { background-color: #4a90e2; }
        .boton-peligro { background-color: #d0021b; }
        .boton-secundario { background-color: #4a4a4a; }

        #form-personal { display: grid; gap: 1.5rem; }
        .fila-formulario { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        
        #lista-personal { list-style: none; padding: 0; margin-top: 1.5rem; }
        #lista-personal li { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid #ccc; }
        .info-persona strong { font-weight: bold; }
        .info-persona span { display: block; font-size: 0.9rem; color: #555; }
        .acciones-persona { display: flex; gap: 0.5rem; margin-left: 1rem; }
        .acciones-persona .boton { padding: 0.4rem 0.8rem; font-size: 0.8rem; }

        .vista-toggle { display: flex; justify-content: center; margin-bottom: 1.5rem; border: 1px solid black; }
        .boton-vista { background-color: #f0f0f0; color: #333; flex: 1; border: none; padding: 0.75rem; font-size: 1rem; font-weight: bold; cursor: pointer; }
        .boton-vista.activo { background-color: #c4c4c4; color: black; }
        
        #cuadrante-container { overflow-x: auto; }
        .tabla-cuadrante { width: 100%; border-collapse: collapse; min-width: 1000px; margin-bottom: 2rem; border: 2px solid var(--color-borde-tabla); }
        .tabla-cuadrante th, .tabla-cuadrante td { border: 1px solid var(--color-borde-tabla); text-align: center; padding: 0.25rem; font-size: 1rem; height: 50px; vertical-align: middle; }
        
        .tabla-cuadrante thead th { font-weight: bold; background-color: var(--color-header-dia); }
        .tabla-cuadrante tbody tr { cursor: grab; background-color: var(--color-defecto); }
        .header-nombre { background-color: var(--color-header-nombre); font-weight: bold; width: 150px; }
        
        .turno { font-weight: bold; font-size: 1.1rem; display: block; }
        .horas { display: block; font-size: 1rem; }
        .celda-total-horas { font-weight: bold; background-color: #f0f0f0; }
        
        .tabla-cuadrante tbody tr.dragging { opacity: 0.6; cursor: grabbing; }

        /* Celda de fin de semana */
        .finde { background-color: var(--color-finde); }

        #patron-visual { display: flex; flex-wrap: wrap; gap: 0.5rem; background: #f0f0f0; border: 1px solid #999; padding: 0.5rem; min-height: 40px; }
        .turno-letra { width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; color: var(--color-texto-principal); border: 1px solid #ccc; background-color: white; }
        #ciclo-builder-botones { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; }
    </style>
</head>
<body>

    <div class="container">
        <header><h1>Cuadrante de Turnos</h1></header>

        <main class="seccion">
            <h2>Gestión de Personal</h2>
            <form id="form-personal">
                <input type="hidden" id="persona-id">
                <div class="fila-formulario">
                    <div class="control-grupo">
                        <label for="persona-nombre">Nombre</label>
                        <input type="text" id="persona-nombre" required placeholder="Ej: MATI 7967">
                    </div>
                    <div class="control-grupo">
                        <label for="persona-fecha-inicio">Fecha de inicio (primer turno del ciclo)</label>
                        <input type="date" id="persona-fecha-inicio" required>
                    </div>
                </div>
                <div class="control-grupo">
                    <label>Crea el Patrón del Ciclo</label>
                    <div id="patron-visual"></div>
                    <input type="hidden" id="persona-ciclo-oculto" required>
                    <div id="ciclo-builder-botones">
                        <button type="button" class="boton" style="background-color:#fff; color:black;" data-turno="M">Mañana</button>
                        <button type="button" class="boton" style="background-color:#fff; color:black;" data-turno="T">Tarde</button>
                        <button type="button" class="boton" style="background-color:#fff; color:black;" data-turno="N">Noche</button>
                        <button type="button" class="boton" style="background-color:#fff; color:black;" data-turno="F">Fiesta</button>
                        <button type="button" id="btn-delete-last" class="boton boton-secundario">Borrar Último</button>
                    </div>
                </div>
                <button type="submit" class="boton boton-principal" style="padding: 0.8rem;">Guardar Persona</button>
            </form>
            <ul id="lista-personal"></ul>
        </main>
        
        <section class="seccion">
            <h2>Cuadrante</h2>
            <div class="vista-toggle">
                <button id="vista-mes" class="boton-vista activo">Vista Mensual</button>
                <button id="vista-ano" class="boton-vista">Vista Anual</button>
            </div>
            <div class="fila-formulario">
                <div class="control-grupo" id="selector-mes-grupo">
                    <label for="mes">Mes</label>
                    <select id="mes"></select>
                </div>
                <div class="control-grupo">
                    <label for="ano">Año</label>
                    <input type="number" id="ano">
                </div>
            </div>
            <div id="cuadrante-container" style="margin-top: 1.5rem;"></div>
        </section>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const selectorMes = document.getElementById('mes');
        const selectorMesGrupo = document.getElementById('selector-mes-grupo');
        const inputAno = document.getElementById('ano');
        const cuadranteContainer = document.getElementById('cuadrante-container');
        const formPersonal = document.getElementById('form-personal');
        const inputPersonaId = document.getElementById('persona-id');
        const inputPersonaNombre = document.getElementById('persona-nombre');
        const inputPersonaFechaInicio = document.getElementById('persona-fecha-inicio');
        const listaPersonalContainer = document.getElementById('lista-personal');
        const patronVisual = document.getElementById('patron-visual');
        const inputCicloOculto = document.getElementById('persona-ciclo-oculto');
        const cicloBuilderBotones = document.getElementById('ciclo-builder-botones');
        const btnDeleteLast = document.getElementById('btn-delete-last');
        const btnVistaMes = document.getElementById('vista-mes');
        const btnVistaAno = document.getElementById('vista-ano');
        
        let personal = [];
        let cicloEnConstruccion = [];
        let vistaActual = 'mes';

        const mesesNombres = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        const actualizarVista = () => {
            selectorMesGrupo.style.display = vistaActual === 'mes' ? 'block' : 'none';
            btnVistaMes.classList.toggle('activo', vistaActual === 'mes');
            btnVistaAno.classList.toggle('activo', vistaActual === 'ano');
            generarCuadrante();
        };

        btnVistaMes.addEventListener('click', () => { vistaActual = 'mes'; actualizarVista(); });
        btnVistaAno.addEventListener('click', () => { vistaActual = 'ano'; actualizarVista(); });

        const actualizarVistaCiclo = () => {
            patronVisual.innerHTML = '';
            cicloEnConstruccion.forEach(turno => {
                const span = document.createElement('span');
                span.className = 'turno-letra';
                span.textContent = turno;
                patronVisual.appendChild(span);
            });
            inputCicloOculto.value = cicloEnConstruccion.join('');
        };

        cicloBuilderBotones.addEventListener('click', e => e.target.dataset.turno && (cicloEnConstruccion.push(e.target.dataset.turno), actualizarVistaCiclo()));
        btnDeleteLast.addEventListener('click', () => (cicloEnConstruccion.pop(), actualizarVistaCiclo()));
        
        const guardarEnLocalStorage = () => {
            localStorage.setItem('cuadrantePersonal', JSON.stringify(personal));
            localStorage.setItem('cuadranteMesGuardado', selectorMes.value);
            localStorage.setItem('cuadranteAnoGuardado', inputAno.value);
        };
        const cargarDesdeLocalStorage = () => {
            const datosGuardados = localStorage.getItem('cuadrantePersonal');
            personal = datosGuardados ? JSON.parse(datosGuardados) : [];
        };

        const renderizarListaPersonal = () => {
            listaPersonalContainer.innerHTML = '';
            if (personal.length > 0) {
                 const h3 = document.createElement('h3');
                 h3.textContent = 'Personal Guardado';
                 listaPersonalContainer.appendChild(h3);
            }
            personal.forEach(p => {
                const li = document.createElement('li');
                li.innerHTML = `<div class="info-persona"><strong>${p.nombre}</strong><span>${p.ciclo.join(' ')}</span></div><div class="acciones-persona"><button class="boton boton-secundario" onclick="iniciarEdicion('${p.id}')">Editar</button><button class="boton boton-peligro" onclick="eliminarPersonal('${p.id}')">Eliminar</button></div>`;
                listaPersonalContainer.appendChild(li);
            });
        };
        
        const resetearFormulario = () => {
            formPersonal.reset();
            inputPersonaId.value = '';
            cicloEnConstruccion = [];
            actualizarVistaCiclo();
        };

        formPersonal.addEventListener('submit', e => {
            e.preventDefault();
            if (inputCicloOculto.value.length === 0) return alert('El patrón del ciclo no puede estar vacío.');
            const id = inputPersonaId.value;
            const nuevaPersona = { nombre: inputPersonaNombre.value, ciclo: inputCicloOculto.value.split(''), fechaInicio: inputPersonaFechaInicio.value };
            if (id) Object.assign(personal.find(p => p.id === id), nuevaPersona);
            else personal.push({ ...nuevaPersona, id: Date.now().toString() });
            renderizarListaPersonal();
            resetearFormulario();
            generarCuadrante();
        });

        window.iniciarEdicion = id => {
            const persona = personal.find(p => p.id === id);
            if (persona) {
                inputPersonaId.value = persona.id;
                inputPersonaNombre.value = persona.nombre;
                inputPersonaFechaInicio.value = persona.fechaInicio;
                cicloEnConstruccion = [...persona.ciclo];
                actualizarVistaCiclo();
                formPersonal.scrollIntoView({ behavior: 'smooth' });
            }
        };

        window.eliminarPersonal = id => {
            if (confirm('¿Estás seguro de que quieres eliminar a esta persona?')) {
                personal = personal.filter(p => p.id !== id);
                renderizarListaPersonal();
                generarCuadrante();
            }
        };

        const inicializarControlesFecha = () => {
            selectorMes.innerHTML = mesesNombres.map((mes, index) => `<option value="${index}">${mes}</option>`).join('');
            const mesGuardado = localStorage.getItem('cuadranteMesGuardado');
            const anoGuardado = localStorage.getItem('cuadranteAnoGuardado');
            const fechaActual = new Date();
            selectorMes.value = mesGuardado || fechaActual.getMonth();
            inputAno.value = anoGuardado || fechaActual.getFullYear();
        };
        
        const generarHtmlTabla = (mes, ano) => {
            const diasEnMes = new Date(ano, mes + 1, 0).getDate();
            let tablaHTML = `<h3>${mesesNombres[mes].toUpperCase()} ${ano}</h3><table class="tabla-cuadrante"><thead><tr><th></th>`;
            for (let dia = 1; dia <= diasEnMes; dia++) tablaHTML += `<th>${dia}</th>`;
            tablaHTML += '<th>Total</th></tr></thead><tbody>';
            personal.forEach(p => {
                tablaHTML += `<tr draggable="true" data-id="${p.id}"><td class="header-nombre">${p.nombre}</td>`;
                let horasTrabajadas = 0;
                const horasPorTurno = 8;
                const fechaInicioCiclo = new Date(p.fechaInicio);
                fechaInicioCiclo.setMinutes(fechaInicioCiclo.getMinutes() + fechaInicioCiclo.getTimezoneOffset());
                const primerDiaDelMes = new Date(ano, mes, 1);
                const diferenciaDias = Math.floor((primerDiaDelMes - fechaInicioCiclo) / (1000 * 60 * 60 * 24));
                const indiceInicio = (diferenciaDias % p.ciclo.length + p.ciclo.length) % p.ciclo.length;
                for (let dia = 1; dia <= diasEnMes; dia++) {
                    const fechaDelDia = new Date(ano, mes, dia);
                    const diaDeLaSemana = fechaDelDia.getDay(); // 0=Domingo, 6=Sábado
                    const esFinde = diaDeLaSemana === 0 || diaDeLaSemana === 6;

                    const indiceActual = (indiceInicio + dia - 1) % p.ciclo.length;
                    const turno = p.ciclo[indiceActual].toUpperCase();
                    let contenidoCelda = '';
                    if (turno !== 'F' && turno !== 'L' && turno !== ' ') {
                        contenidoCelda = `<span class="turno">${turno}</span><span class="horas">${horasPorTurno}</span>`;
                        horasTrabajadas += horasPorTurno;
                    }
                    const claseFinde = esFinde ? 'finde' : '';
                    tablaHTML += `<td class="${claseFinde}">${contenidoCelda}</td>`;
                }
                tablaHTML += `<td class="celda-total-horas">${horasTrabajadas}</td></tr>`;
            });
            return tablaHTML + '</tbody></table>';
        };

        const generarCuadrante = () => {
            const ano = parseInt(inputAno.value);
            let htmlFinal = '';

            if (vistaActual === 'mes') {
                const mes = parseInt(selectorMes.value);
                htmlFinal = generarHtmlTabla(mes, ano);
            } else {
                for (let mes = 0; mes < 12; mes++) {
                    htmlFinal += generarHtmlTabla(mes, ano);
                }
            }

            cuadranteContainer.innerHTML = personal.length > 0 ? htmlFinal : '<p style="text-align:center;">Añade personal para ver el cuadrante.</p>';
            setupDragAndDrop();
            guardarEnLocalStorage();
        };

        function setupDragAndDrop() {
            cuadranteContainer.addEventListener('dragstart', e => { if(e.target.tagName === 'TR') e.target.classList.add('dragging'); });
            cuadranteContainer.addEventListener('dragend', e => { if(e.target.tagName === 'TR') e.target.classList.remove('dragging'); });
            cuadranteContainer.addEventListener('drop', e => {
                e.preventDefault();
                const targetRow = e.target.closest('tr');
                const draggingRow = cuadranteContainer.querySelector('.dragging');
                if (!targetRow || !draggingRow || targetRow === draggingRow) return;
                const draggedId = draggingRow.dataset.id;
                const targetId = targetRow.dataset.id;
                const draggedIndex = personal.findIndex(p => p.id === draggedId);
                const targetIndex = personal.findIndex(p => p.id === targetId);
                const [draggedItem] = personal.splice(draggedIndex, 1);
                personal.splice(targetIndex, 0, draggedItem);
                generarCuadrante();
                renderizarListaPersonal();
            });
            cuadranteContainer.addEventListener('dragover', e => e.preventDefault());
        }

        selectorMes.addEventListener('change', generarCuadrante);
        inputAno.addEventListener('change', generarCuadrante);

        cargarDesdeLocalStorage();
        inicializarControlesFecha();
        renderizarListaPersonal();
        actualizarVista();
    });
    </script>
</body>
</html>
