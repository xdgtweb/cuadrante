<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuadrante de Turnos Profesional</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --color-primario: #3b82f6; --color-primario-hover: #2563eb;
            --color-fondo: #f8fafc; --color-superficie: #ffffff;
            --color-borde: #e2e8f0; --color-texto-principal: #0f172a;
            --color-texto-secundario: #64748b;
            --sombra-caja: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --radio-borde: 0.5rem;
            --color-manana: #a7d8f5; --color-tarde: #f7d6b5;
            --color-noche: #d1c4e9;  --color-fiesta: #ffffff;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: var(--font-family); background-color: var(--color-fondo);
            color: var(--color-texto-principal); margin: 0; padding: 1.5rem;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }

        .container { max-width: 1400px; margin: auto; display: grid; gap: 2rem; }
        
        h1, h2, h3 { text-align: center; color: var(--color-texto-principal); margin: 0 0 1rem 0; font-weight: 700; }
        h1 { font-size: 2.25rem; } h2 { font-size: 1.5rem; } h3 { font-size: 1.25rem; color: var(--color-texto-secundario);}

        .seccion {
            background-color: var(--color-superficie); padding: 2rem;
            border-radius: var(--radio-borde); box-shadow: var(--sombra-caja);
            border: 1px solid var(--color-borde);
        }

        .control-grupo { display: flex; flex-direction: column; }
        .control-grupo label { margin-bottom: 0.5rem; font-weight: 500; color: var(--color-texto-secundario); }
        .control-grupo select, .control-grupo input {
            padding: 0.75rem 1rem; border: 1px solid var(--color-borde);
            border-radius: var(--radio-borde); width: 100%; font-family: inherit; font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .control-grupo select:focus, .control-grupo input:focus {
            outline: none; border-color: var(--color-primario);
            box-shadow: 0 0 0 3px rgb(59 130 246 / 0.2);
        }

        .boton {
            padding: 0.75rem 1.5rem; color: white; border: none;
            border-radius: var(--radio-borde); cursor: pointer; font-weight: 600;
            text-align: center; font-size: 1rem; transition: all 0.2s;
        }
        .boton:active { transform: scale(0.98); }
        .boton-principal { background-color: var(--color-primario); } .boton-principal:hover { background-color: var(--color-primario-hover); }
        .boton-peligro { background-color: #ef4444; } .boton-peligro:hover { background-color: #dc2626; }
        .boton-secundario { background-color: var(--color-texto-secundario); } .boton-secundario:hover { background-color: #475569; }

        #form-personal { display: grid; gap: 1.5rem; }
        .fila-formulario { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        
        #lista-personal { list-style: none; padding: 0; margin-top: 2rem; border-top: 1px solid var(--color-borde); }
        #lista-personal li { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid var(--color-borde); }
        .info-persona strong { font-weight: 600; }
        .info-persona span { display: block; font-size: 0.875rem; color: var(--color-texto-secundario); font-family: monospace; }
        .acciones-persona { display: flex; gap: 0.5rem; margin-left: 1rem; }
        .acciones-persona .boton { padding: 0.5rem 1rem; font-size: 0.875rem; }

        .vista-toggle { display: flex; justify-content: center; margin-bottom: 1.5rem; background-color: var(--color-fondo); border-radius: var(--radio-borde); padding: 0.25rem; }
        .boton-vista { background-color: transparent; color: var(--color-texto-secundario); flex: 1; border: none; padding: 0.75rem; font-size: 1rem; font-weight: 600; cursor: pointer; border-radius: 0.5rem; transition: all 0.3s; }
        .boton-vista.activo { background-color: var(--color-superficie); color: var(--color-primario); box-shadow: var(--sombra-caja); }
        
        #cuadrante-container { overflow-x: auto; }
        .tabla-cuadrante { width: 100%; border-collapse: collapse; min-width: 1200px; margin-bottom: 3rem; }
        .tabla-cuadrante th, .tabla-cuadrante td { text-align: center; padding: 0.5rem 0.25rem; font-size: 0.875rem; height: 55px; }
        .tabla-cuadrante thead th { background-color: var(--color-fondo); font-weight: 600; color: var(--color-texto-secundario); position: sticky; top: 0; border-bottom: 2px solid var(--color-borde); }
        .tabla-cuadrante tbody tr { border-bottom: 1px solid var(--color-borde); cursor: grab; }
        .tabla-cuadrante tbody tr:last-child { border-bottom: none; }
        .header-nombre { background-color: var(--color-superficie); font-weight: 600; width: 170px; position: sticky; left: 0; border-right: 2px solid var(--color-borde); }
        .turno { font-weight: 600; font-size: 1rem; } .horas { display: block; font-size: 0.75rem; color: var(--color-texto-secundario); }
        .celda-total-horas { font-weight: 600; background-color: var(--color-fondo); border-left: 2px solid var(--color-borde); }
        
        .tabla-cuadrante tbody tr.dragging { opacity: 0.5; background: var(--color-primario); cursor: grabbing; }

        .turno-m { background-color: var(--color-manana); } .turno-t { background-color: var(--color-tarde); }
        .turno-n { background-color: var(--color-noche); } .turno-f { background-color: var(--color-fiesta); }

        #patron-visual { display: flex; flex-wrap: wrap; gap: 0.5rem; background: var(--color-fondo); border: 1px solid var(--color-borde); border-radius: var(--radio-borde); padding: 0.75rem; min-height: 50px; }
        .turno-letra { width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: 700; color: var(--color-texto-principal); }
        #ciclo-builder-botones { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; }

        /* --- ESTILOS PARA LA VISTA MÓVIL --- */
        @media (max-width: 768px) {
            body { padding: 0.5rem; }
            .seccion { padding: 1rem; }
            .tabla-cuadrante { min-width: 100%; border: none; }
            .tabla-cuadrante thead { display: none; }
            .tabla-cuadrante, .tabla-cuadrante tbody, .tabla-cuadrante tr, .tabla-cuadrante td { display: block; }
            .tabla-cuadrante tr { border: 1px solid var(--color-borde); border-radius: var(--radio-borde); margin-bottom: 1rem; padding: 0.5rem; box-shadow: var(--sombra-caja); }
            .tabla-cuadrante td { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; text-align: right; border: none; border-bottom: 1px solid var(--color-borde); }
            .tabla-cuadrante td:last-child { border-bottom: none; }
            .tabla-cuadrante td::before { content: attr(data-label); font-weight: 600; text-align: left; color: var(--color-texto-secundario); margin-right: 1rem; }
            .header-nombre { position: static; width: 100%; border: none; font-size: 1.25rem; padding: 1rem; justify-content: center; color: var(--color-primario); }
            .header-nombre::before { display: none; }
            .celda-total-horas { font-size: 1rem; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header><h1>Cuadrante de Turnos</h1></header>

        <main class="seccion">
            <h2>Gestión de Personal</h2>
            <form id="form-personal">
                <input type="hidden" id="persona-id">
                <div class="fila-formulario">
                    <div class="control-grupo">
                        <label for="persona-nombre">Nombre</label>
                        <input type="text" id="persona-nombre" required placeholder="Ej: Ana Pérez">
                    </div>
                    <div class="control-grupo">
                        <label for="persona-fecha-inicio">Fecha de inicio (primer turno del ciclo)</label>
                        <input type="date" id="persona-fecha-inicio" required>
                    </div>
                </div>
                <div class="control-grupo">
                    <label>Crea el Patrón del Ciclo</label>
                    <div id="patron-visual"></div>
                    <input type="hidden" id="persona-ciclo-oculto" required>
                    <div id="ciclo-builder-botones">
                        <button type="button" class="boton" style="background-color:var(--color-manana); color:black;" data-turno="M">Mañana</button>
                        <button type="button" class="boton" style="background-color:var(--color-tarde); color:black;" data-turno="T">Tarde</button>
                        <button type="button" class="boton" style="background-color:var(--color-noche); color:black;" data-turno="N">Noche</button>
                        <button type="button" class="boton" style="background-color:var(--color-fiesta); color:black; border: 1px solid var(--color-borde);" data-turno="F">Fiesta</button>
                        <button type="button" id="btn-delete-last" class="boton boton-secundario">Borrar Último</button>
                    </div>
                </div>
                <button type="submit" class="boton boton-principal" style="padding: 1rem; font-size: 1.1rem;">Guardar Persona</button>
            </form>
            <ul id="lista-personal"></ul>
        </main>
        
        <section class="seccion">
            <h2>Cuadrante</h2>
            <div class="vista-toggle">
                <button id="vista-mes" class="boton-vista activo">Vista Mensual</button>
                <button id="vista-ano" class="boton-vista">Vista Anual</button>
            </div>
            <div class="fila-formulario">
                <div class="control-grupo" id="selector-mes-grupo">
                    <label for="mes">Mes</label>
                    <select id="mes"></select>
                </div>
                <div class="control-grupo">
                    <label for="ano">Año</label>
                    <input type="number" id="ano">
                </div>
            </div>
            <div id="cuadrante-container" style="margin-top: 1.5rem;"></div>
        </section>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Selectores del DOM ---
        const selectorMes = document.getElementById('mes');
        const selectorMesGrupo = document.getElementById('selector-mes-grupo');
        const inputAno = document.getElementById('ano');
        const cuadranteContainer = document.getElementById('cuadrante-container');
        const formPersonal = document.getElementById('form-personal');
        const inputPersonaId = document.getElementById('persona-id');
        const inputPersonaNombre = document.getElementById('persona-nombre');
        const inputPersonaFechaInicio = document.getElementById('persona-fecha-inicio');
        const listaPersonalContainer = document.getElementById('lista-personal');
        const patronVisual = document.getElementById('patron-visual');
        const inputCicloOculto = document.getElementById('persona-ciclo-oculto');
        const cicloBuilderBotones = document.getElementById('ciclo-builder-botones');
        const btnDeleteLast = document.getElementById('btn-delete-last');
        const btnVistaMes = document.getElementById('vista-mes');
        const btnVistaAno = document.getElementById('vista-ano');
        
        // --- Estado de la aplicación ---
        let personal = [];
        let cicloEnConstruccion = [];
        let vistaActual = 'mes'; // 'mes' o 'ano'

        const mesesNombres = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        // --- LÓGICA DE LA INTERFAZ ---
        const actualizarVista = () => {
            if (vistaActual === 'mes') {
                btnVistaMes.classList.add('activo');
                btnVistaAno.classList.remove('activo');
                selectorMesGrupo.style.display = 'block';
            } else {
                btnVistaAno.classList.add('activo');
                btnVistaMes.classList.remove('activo');
                selectorMesGrupo.style.display = 'none';
            }
            generarCuadrante();
        };

        btnVistaMes.addEventListener('click', () => { vistaActual = 'mes'; actualizarVista(); });
        btnVistaAno.addEventListener('click', () => { vistaActual = 'ano'; actualizarVista(); });

        // --- LÓGICA DEL CONSTRUCTOR DE CICLOS ---
        const actualizarVistaCiclo = () => {
            patronVisual.innerHTML = '';
            cicloEnConstruccion.forEach(turno => {
                const span = document.createElement('span');
                span.className = `turno-letra turno-${turno.toLowerCase()}`;
                span.textContent = turno;
                patronVisual.appendChild(span);
            });
            inputCicloOculto.value = cicloEnConstruccion.join('');
        };

        cicloBuilderBotones.addEventListener('click', e => e.target.dataset.turno && (cicloEnConstruccion.push(e.target.dataset.turno), actualizarVistaCiclo()));
        btnDeleteLast.addEventListener('click', () => (cicloEnConstruccion.pop(), actualizarVistaCiclo()));
        
        // --- GESTIÓN DE DATOS (LocalStorage) ---
        const guardarEnLocalStorage = () => {
            localStorage.setItem('cuadrantePersonal', JSON.stringify(personal));
            localStorage.setItem('cuadranteMesGuardado', selectorMes.value);
            localStorage.setItem('cuadranteAnoGuardado', inputAno.value);
        };
        const cargarDesdeLocalStorage = () => {
            const datosGuardados = localStorage.getItem('cuadrantePersonal');
            personal = datosGuardados ? JSON.parse(datosGuardados) : [];
        };

        // --- GESTIÓN DE PERSONAL (CRUD) ---
        const renderizarListaPersonal = () => {
            listaPersonalContainer.innerHTML = '';
            if (personal.length > 0) {
                 const h3 = document.createElement('h3');
                 h3.textContent = 'Personal Guardado';
                 listaPersonalContainer.appendChild(h3);
            }
            personal.forEach(p => {
                const li = document.createElement('li');
                li.innerHTML = `<div class="info-persona"><strong>${p.nombre}</strong><span>${p.ciclo.join(' ')}</span></div><div class="acciones-persona"><button class="boton boton-secundario" onclick="iniciarEdicion('${p.id}')">Editar</button><button class="boton boton-peligro" onclick="eliminarPersonal('${p.id}')">Eliminar</button></div>`;
                listaPersonalContainer.appendChild(li);
            });
        };
        
        const resetearFormulario = () => {
            formPersonal.reset();
            inputPersonaId.value = '';
            cicloEnConstruccion = [];
            actualizarVistaCiclo();
        };

        formPersonal.addEventListener('submit', e => {
            e.preventDefault();
            if (inputCicloOculto.value.length === 0) return alert('El patrón del ciclo no puede estar vacío.');
            const id = inputPersonaId.value;
            const nuevaPersona = { nombre: inputPersonaNombre.value, ciclo: inputCicloOculto.value.split(''), fechaInicio: inputPersonaFechaInicio.value };
            if (id) Object.assign(personal.find(p => p.id === id), nuevaPersona);
            else personal.push({ ...nuevaPersona, id: Date.now().toString() });
            renderizarListaPersonal();
            resetearFormulario();
            generarCuadrante();
        });

        window.iniciarEdicion = id => {
            const persona = personal.find(p => p.id === id);
            if (persona) {
                inputPersonaId.value = persona.id;
                inputPersonaNombre.value = persona.nombre;
                inputPersonaFechaInicio.value = persona.fechaInicio;
                cicloEnConstruccion = [...persona.ciclo];
                actualizarVistaCiclo();
                formPersonal.scrollIntoView({ behavior: 'smooth' });
            }
        };

        window.eliminarPersonal = id => {
            if (confirm('¿Estás seguro de que quieres eliminar a esta persona?')) {
                personal = personal.filter(p => p.id !== id);
                renderizarListaPersonal();
                generarCuadrante();
            }
        };

        // --- LÓGICA DEL CUADRANTE ---
        const inicializarControlesFecha = () => {
            selectorMes.innerHTML = mesesNombres.map((mes, index) => `<option value="${index}">${mes}</option>`).join('');
            const mesGuardado = localStorage.getItem('cuadranteMesGuardado');
            const anoGuardado = localStorage.getItem('cuadranteAnoGuardado');
            const fechaActual = new Date();
            selectorMes.value = mesGuardado || fechaActual.getMonth();
            inputAno.value = anoGuardado || fechaActual.getFullYear();
        };
        
        const generarHtmlTabla = (mes, ano) => {
            const diasEnMes = new Date(ano, mes + 1, 0).getDate();
            let tablaHTML = `<h3>${mesesNombres[mes]} ${ano}</h3><table class="tabla-cuadrante"><thead><tr><th class="header-nombre">Personal</th>`;
            for (let dia = 1; dia <= diasEnMes; dia++) tablaHTML += `<th>${dia}</th>`;
            tablaHTML += '<th class="celda-total-horas">Total</th></tr></thead><tbody>';
            personal.forEach(p => {
                tablaHTML += `<tr draggable="true" data-id="${p.id}"><td class="header-nombre" data-label="Personal">${p.nombre}</td>`;
                let horasTrabajadas = 0;
                const horasPorTurno = 8;
                const fechaInicioCiclo = new Date(p.fechaInicio);
                fechaInicioCiclo.setMinutes(fechaInicioCiclo.getMinutes() + fechaInicioCiclo.getTimezoneOffset());
                const primerDiaDelMes = new Date(ano, mes, 1);
                const diferenciaDias = Math.floor((primerDiaDelMes - fechaInicioCiclo) / (1000 * 60 * 60 * 24));
                const indiceInicio = (diferenciaDias % p.ciclo.length + p.ciclo.length) % p.ciclo.length;
                for (let dia = 1; dia <= diasEnMes; dia++) {
                    const indiceActual = (indiceInicio + dia - 1) % p.ciclo.length;
                    const turno = p.ciclo[indiceActual].toUpperCase();
                    let contenidoCelda = '';
                    if (turno !== 'F' && turno !== 'L' && turno !== ' ') {
                        contenidoCelda = `<span class="turno">${turno}</span><span class="horas">${horasPorTurno}h</span>`;
                        horasTrabajadas += horasPorTurno;
                    }
                    tablaHTML += `<td data-label="Día ${dia}" class="turno-${turno.toLowerCase()}">${contenidoCelda}</td>`;
                }
                tablaHTML += `<td data-label="Total Horas" class="celda-total-horas">${horasTrabajadas}</td></tr>`;
            });
            return tablaHTML + '</tbody></table>';
        };

        const generarCuadrante = () => {
            const ano = parseInt(inputAno.value);
            let htmlFinal = '';

            if (vistaActual === 'mes') {
                const mes = parseInt(selectorMes.value);
                htmlFinal = generarHtmlTabla(mes, ano);
            } else {
                for (let mes = 0; mes < 12; mes++) {
                    htmlFinal += generarHtmlTabla(mes, ano);
                }
            }

            cuadranteContainer.innerHTML = personal.length > 0 ? htmlFinal : '<p style="text-align:center; color: var(--color-texto-secundario);">Añade personal para ver el cuadrante.</p>';
            setupDragAndDrop();
            guardarEnLocalStorage();
        };

        // --- LÓGICA DE DRAG AND DROP ---
        function setupDragAndDrop() {
            cuadranteContainer.addEventListener('dragstart', e => {
                if(e.target.tagName === 'TR') {
                    e.target.classList.add('dragging');
                }
            });

            cuadranteContainer.addEventListener('dragend', e => {
                 if(e.target.tagName === 'TR') {
                    e.target.classList.remove('dragging');
                }
            });

            cuadranteContainer.addEventListener('drop', e => {
                e.preventDefault();
                const targetRow = e.target.closest('tr');
                const draggingRow = cuadranteContainer.querySelector('.dragging');
                if (!targetRow || !draggingRow || targetRow === draggingRow) return;

                const draggedId = draggingRow.dataset.id;
                const targetId = targetRow.dataset.id;

                const draggedIndex = personal.findIndex(p => p.id === draggedId);
                const targetIndex = personal.findIndex(p => p.id === targetId);
                
                const [draggedItem] = personal.splice(draggedIndex, 1);
                personal.splice(targetIndex, 0, draggedItem);
                
                generarCuadrante();
                renderizarListaPersonal();
            });
            
            // Prevenir el comportamiento por defecto para que 'drop' funcione
            cuadranteContainer.addEventListener('dragover', e => e.preventDefault());
        }

        // --- INICIALIZACIÓN ---
        selectorMes.addEventListener('change', generarCuadrante);
        inputAno.addEventListener('change', generarCuadrante);

        cargarDesdeLocalStorage();
        inicializarControlesFecha();
        renderizarListaPersonal();
        actualizarVista();
    });
    </script>
</body>
</html>

